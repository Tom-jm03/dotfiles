from i3pystatus.core.util import internet, require
from i3pystatus.weather import Backend

from datetime import datetime
from urllib.request import urlopen
import re
import requests
import xml.etree.ElementTree as ElementTree

OPENWEATHERMAP_URL = 'http://api.openweathermap.org/data/2.5/weather?q=%s&units=%s&appid=%s'
ON_LEFTCLICK_URL = 'https://weather.com/weather/today/l/%s'


class Openweathermap(Backend):
    settings = (
        ('city', 'City for which to show the weather'),
        ('appid', 'API key for openweathermap.com'),
        ('units', '\'metric\' or \'imperial\''),
    )
    required = ('city', 'appid')

    city = None
    appid = None

    units = 'metric'

    # This will be set once weather data has been checked
    forecast_url = None

    @require(internet)
    def weather_data(self):
        '''
        Fetches the current weather from openweathermap.com service.
        '''
        if self.forecast_url is None and ':' in self.city:
            # Set the URL so that clicking the weather will launch the
            # weather.com forecast page. Only set it though if there is a colon
            # in the location_code. Technically, the weather.com API will
            # successfully return weather data if a U.S. ZIP code is used as
            # the location_code (e.g. 94107), but if substituted in
            # ON_LEFTCLICK_URL it may or may not result in a valid URL.
            self.forecast_url = ON_LEFTCLICK_URL % self.city

        unit = '' if self.units == 'imperial' or self.units == '' else 'm'
        url = OPENWEATHERMAP_URL % (self.city, unit, self.appid)
        response = requests.get(url)
        if response.status_code != 200:
            raise Exception('Failed to fetch weather data!')
        data = response.json()

        return dict(
            city=data['name'],
            condition=data['weather'][0]['description'],
            current_temp=f"{float(data['main']['temp']) - 273.15:.2f}",
            low_temp=data['main']['temp_min'],
            high_temp=data['main']['temp_max'],
            temp_unit='Â°C',
            feelslike=data['main']['feels_like'],
            wind_speed=data['wind']['speed'],
            wind_direction=data['wind']['deg'],
            wind_gust=data['wind']['gust'],
            pressure=data['main']['pressure'],
            humidity=data['main']['humidity'],
            sea_level=data['main']['sea_level'],
        )
